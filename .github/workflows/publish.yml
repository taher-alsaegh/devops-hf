name: Build & Publish Python Package to Azure DevOps Feed

on:
  push:
    branches: [ main ]
  workflow_dispatch: {}

jobs:
  publish:
    name: Build & Publish Python Package to Azure DevOps Feed
    runs-on: ubuntu-latest
    if: ${{ github.ref == 'refs/heads/main' }}
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install build tooling
        run: |
          pip install --upgrade pip
          pip install build twine

      - name: Build package (sdist + wheel)
        run: python -m build

      - name: Publish to Azure DevOps Feed
        run: |
          twine upload \
            --repository-url "https://pkgs.dev.azure.com/${{ secrets.AZDO_ORG }}/${{ secrets.AZDO_PROJECT }}/_packaging/${{ secrets.AZDO_FEED }}/pypi/upload/" \
            -u azdo -p ${{ secrets.AZDO_PAT }} dist/*

      - name: Verify install (no upstream caching)
        env:
          FEED: "https://azdo:${{ secrets.AZDO_PAT }}@pkgs.dev.azure.com/${{ secrets.AZDO_ORG }}/${{ secrets.AZDO_PROJECT }}/_packaging/${{ secrets.AZDO_FEED }}/pypi/simple/"
        run: |
          python -m venv venv
          source venv/bin/activate
          pip install --upgrade pip
          # Dependencies von PyPI, dein Paket aus Azure Feed
          pip install --index-url https://pypi.org/simple --extra-index-url "$FEED" my-python-package==0.1.5


  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS CLI
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
          aws-region: us-east-1

      - name: Generate cloud-config
        run: |
          cat > cloud-config.yaml <<'EOF'
          #cloud-config
          users:
            - name: ubuntu
              shell: /bin/bash
              groups: [sudo]
              sudo: ["ALL=(ALL) NOPASSWD:ALL"]
              ssh_authorized_keys:
                - ${{ secrets.SSH_PUBLIC_KEY }}

          package_update: true
          packages:
            - python3
            - python3-venv
            - python3-pip

          runcmd:
            - [ bash, -lc, "mkdir -p /opt/flaskapp && chown -R ubuntu:ubuntu /opt/flaskapp" ]
            - [ bash, -lc, "sudo -u ubuntu -H python3 -m venv /opt/flaskapp/venv" ]
            - [ bash, -lc, "sudo -u ubuntu -H /opt/flaskapp/venv/bin/pip install --upgrade pip" ]
            - [ bash, -lc, "sudo -u ubuntu -H /opt/flaskapp/venv/bin/pip install --index-url https://pypi.org/simple --extra-index-url https://azdo:${{ secrets.AZDO_PAT }}@pkgs.dev.azure.com/${{ secrets.AZDO_ORG }}/${{ secrets.AZDO_PROJECT }}/_packaging/${{ secrets.AZDO_FEED }}/pypi/simple/ my-python-package==0.1.3" ]
            - [ bash, -lc, "systemctl daemon-reload" ]
          EOF

      - name: Launch EC2 instance with cloud-init
        run: |
          aws ec2 run-instances \
            --image-id ami-0360c520857e3138f \
            --instance-type t3.micro \
            --key-name webserver \
            --security-group-ids sg-036ccc3c2f023b457 \
            --subnet-id subnet-02860236dcb261e54 \
            --user-data file://cloud-config.yaml \
            --tag-specifications 'ResourceType=instance,Tags=[{Key=Name,Value=my-flaskapp}]'
